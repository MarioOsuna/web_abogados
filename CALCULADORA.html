<!-- CALCULADORA COMPLETA: FORMULARIO WIZARD FUNCIONAL -->
<!-- Pegable en bloque HTML de WordPress -->

<style>
  :root {
    --color-primary: #f97316;
    --color-primary-hover: #cc5500;
    --color-white: #ffffff;
    --color-gray: #666;
    --font-main: 'Roboto', sans-serif;
    --radius: 8px;
    --button-radius: 16px;
  }

  .wizard-container {
    max-width: 600px;
    margin: auto;
    font-family: var(--font-main);
    background-color: var(--color-white);
    padding: 0;
    border: none;
    border-radius: 0;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.568);
  }

  .wizard-header {
    font-size: 38px;
    font-weight: normal;
    padding: 24px 24px 0;
    text-align: left;
    color: #333;
  }

  .wizard-progress {
    height: 6px;
    background-color: #eee;
    margin: 0 24px;
  }

  .wizard-progress-bar {
    height: 100%;
    background-color: var(--color-primary);
    width: 0%;
    transition: width 0.3s ease;
  }

  .wizard-step {
    display: none;
    padding: 24px;
    animation: fadeInSlide 0.4s ease-in-out forwards;
  }

  .wizard-step.active {
    display: block;
  }

  @keyframes fadeInSlide {
    from {
      opacity: 0;
      transform: translateX(20px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  label {
    font-size: 15px;
    font-weight: 900;
    margin-top: 20px;
    display: block;
    color: #333;
  }

  small {
    font-size: 14px;
    color: var(--color-gray);
    display: block;
    margin-bottom: 8px;
  }

  input[type="text"],
  input[type="number"],
  input[type="date"],
  select {
    width: 100%;
    padding: 10px 12px;
    font-size: 16px;
    font-weight: normal;
    font-family: var(--font-main);
    border: 1px solid #ccc;
    border-radius: var(--radius);
    background-color: #fff;
    box-sizing: border-box;
    margin-top: 6px;
  }

  input[type="radio"] {
    margin-right: 6px;
    accent-color: var(--color-primary);
  }

  .wizard-buttons {
    display: flex;
    justify-content: space-between;
    padding: 24px;
    background: #f9f9f9;
    border-top: 1px solid #ddd;
  }

  .wizard-buttons button {
    background-color: var(--color-primary);
    color: var(--color-white);
    border: none;
    padding: 10px 24px;
    font-size: 14px;
    font-weight: 500;
    border-radius: var(--button-radius);
    cursor: pointer;
    transition: background-color 0.3s ease;
    font-family: var(--font-main);
  }

  .wizard-buttons button:hover {
    background-color: var(--color-primary-hover);
  }

  .wizard-buttons button:disabled {
    background-color: #ccc;
    color: #fff;
    cursor: not-allowed;
  }

  #secuelas button {
    background-color: var(--color-primary);
    color: var(--color-white);
    font-size: 14px;
    font-weight: 500;
    padding: 8px 16px;
    border: none;
    border-radius: var(--button-radius);
    margin: 6px 6px 0 0;
    cursor: pointer;
    transition: background 0.3s ease;
  }

  #secuelas button:hover {
    background-color: var(--color-primary-hover);
  }

  #secuela_listado div {
    background: #f4f4f4;
    border-left: 4px solid var(--color-primary);
    padding: 8px 12px;
    margin-top: 6px;
    border-radius: 4px;
    font-size: 14px;
  }

  .final-message {
    font-size: 18px;
    padding: 24px;
    color: #333;
    place-items: center;
    line-height: 1.5;
  }

  .oculto {
    display: none;
  }
</style>

<div class="wizard-container">
  <div class="wizard-header">Calculadora de indemnizaci√≥n</div>
  <div class="wizard-progress">
    <div class="wizard-progress-bar" id="progress-bar"></div>
  </div>

  <form id="formWizard">
    <!-- Paso 1 -->
    <div class="wizard-step active">
      <label>Edad:</label>
      <input type="number" name="age" min="1" max="99" required>

      <label>Fecha del accidente:</label>
      <input type="date" id="fecha_accidente" required max="">

      <label>Fecha fin de rehabilitaci√≥n:</label>
      <input type="date" id="fecha_rehabilitacion" required max="">
    </div>

    <!-- Paso 2 -->
    <div class="wizard-step">
      <label>¬øEstuvo hospitalizado?</label>
      <label><input type="radio" name="hospitalizado" value="si" required>
        S√≠</label>
      <label><input type="radio" name="hospitalizado" value="no"> No</label>
      <div id="campo_dias_hospital" class="oculto">
        <label>D√≠as hospitalizado:</label>
        <input type="number" id="dias_hospitalizado" min="0" value="0">
      </div>
      <label>¬øEstuvo de baja laboral?</label>
      <label><input type="radio" name="baja" value="si" required> S√≠</label>
      <label><input type="radio" name="baja" value="no"> No</label>

      <div id="campo_dias_baja" class="oculto">
        <label>D√≠as de baja laboral:</label>
        <input type="number" id="dias_baja" min="0" value="0">
      </div>

      <div id="pregunta_tareas" class="oculto">
        <label>¬øEstuvo impedido de realizar tareas?</label>
        <label><input type="radio" name="tareas" value="si"> S√≠</label>
        <label><input type="radio" name="tareas" value="no"> No</label>
      </div>

      <div id="campo_dias_tareas" class="oculto">
        <label>D√≠as sin poder hacer tareas:</label>
        <input type="number" id="dias_tareas" min="0" value="0">
      </div>

    </div>

    <!-- Paso 3 -->
    <div class="wizard-step ">
      <label>¬øHas tenido secuelas?</label>
      <small>Ejemplos: dolores permanentes, contracturas persistentes,
        limitaciones f√≠sicas...</small>
      <label><input type="radio" name="secuelas" value="si" required>
        S√≠</label>
      <label><input type="radio" name="secuelas" value="no"> No</label>
      <div id="secuelas" style="margin-top: 10px;" class="oculto">
        <label style="margin-bottom: 10px;">A√±ade tantas secuelas como hayas
          tenido</label>
        <button type="button" onclick="agregarSecuela('leve')">‚ûï Leve </button>
        <button type="button" onclick="agregarSecuela('moderada')">‚ûï Moderada
        </button>
        <button type="button" onclick="agregarSecuela('grave')">‚ûï Grave
        </button>
      </div>
      <div id="secuela_listado" style="margin-top: 15px;"></div>
    </div>

    <!-- Resultado -->
    <div class="wizard-step final-step">
      <div class="final-message" id="resultado"></div>
    </div>
  </form>

  <div class="wizard-buttons">
    <button id="prevBtn" onclick="changeStep(-1)"
      type="button">Anterior</button>
    <button id="nextBtn" onclick="changeStep(1)"
      type="button">Siguiente</button>
  </div>
</div>

<script>

  const precioHosp = 95.26;
  const precioBaja = 66.04;
  const precioLeve = 38.10;
  const steps = document.querySelectorAll(".wizard-step");
  const progressBar = document.getElementById("progress-bar");
  const nextBtn = document.getElementById("nextBtn");
  const prevBtn = document.getElementById("prevBtn");
  const indemnizaciones = {
    menos_de_10: [1129.00, 2337.00, 3585.00, 4891.00, 6222.88, 7561.62, 8900.37, 10239.12, 11577.87, 12916.62],
    _10_20:      [1092.00, 2251.00, 3468.00, 4731.00, 6018.94, 7313.81, 8608.69, 9903.56, 11198.43, 12493.31],
    _20_30:      [1055.00, 2174.00, 3347.00, 4564.00, 5815.00, 7066.00, 8317.00, 9568.00, 10819.00, 12070.00],
    _30_40:      [1015.00, 2091.57, 3220.10, 4390.96, 5594.53, 6798.09, 8001.66, 9205.23, 10408.80, 11612.37],
    _40_50:      [970.00, 1998.84, 3077.34, 4196.28, 5346.49, 6496.70, 7646.91, 8797.12, 9947.33, 11097.54],
    _50_60:      [911.00, 1877.26, 2890.16, 3941.05, 5021.29, 6101.54, 7181.79, 8262.04, 9342.28, 10422.53],
    _60_70:      [875.00, 1803.08, 2775.95, 3785.31, 5021.29, 6101.54, 7181.79, 8262.04, 9342.28, 10422.53],    
    _70_80:      [843.00, 1737.14, 2674.43, 3646.87, 4619.31, 5646.10, 6645.72, 7645.33, 8644.95, 9644.56],
    _80_90:      [818.00, 1685.62, 2595.11, 3538.72, 4482.33, 5478.66, 6448.63, 7418.60, 8388.57, 9358.54],
    _90_99:      [770.00, 1586.71, 2442.83, 3331.07, 4244.12, 5157.18, 6070.23, 6983.28, 7896.33, 8809.38],
  };
  let currentStep = 0;
  let puntosSecuelas = 0;
  let secuelas = [];

  function obtenerRangoEdad(edad) {
    if (edad < 10) return "menos_de_10";
    if (edad < 20) return "_10_20";
    if (edad < 30) return "_20_30";
    if (edad < 40) return "_30_40";
    if (edad < 50) return "_40_50";
    if (edad < 60) return "_50_60";
    if (edad < 70) return "_60_70";
    if (edad < 80) return "_70_80";
    if (edad < 90) return "_80_90";
    return "_90_99";
  }

  // Mostrar campos din√°micos
  document.querySelectorAll('input[name="hospitalizado"]').forEach(el => {
    el.addEventListener('change', () => {
      const visible = el.value === 'si';
      document.getElementById('campo_dias_hospital').classList.toggle('oculto', !visible);
      validateStep();
    });
  });

  document.querySelectorAll('input[name="baja"]').forEach(el => {
    el.addEventListener('change', () => {
      const si = el.value === 'si';
      document.getElementById('campo_dias_baja').classList.toggle('oculto', !si);
      document.getElementById('pregunta_tareas').classList.toggle('oculto', si);
      document.getElementById('campo_dias_tareas').classList.add('oculto');
      validateStep();
    });
  });

  document.querySelectorAll('input[name="tareas"]').forEach(el => {
    el.addEventListener('change', () => {
      document.getElementById('campo_dias_tareas').classList.toggle('oculto', el.value !== 'si');
      validateStep();
    });
  });

  document.querySelectorAll('input[name="secuelas"]').forEach(el => {
    el.addEventListener('change', () => {
      const visible = el.value === 'si';
      document.getElementById('secuelas').classList.toggle('oculto', !visible);
      validateStep();
    });
  });

  // Validaci√≥n de inputs de n√∫mero y select
  document.querySelectorAll('input[type="number"], input, select').forEach(input => {
    input.addEventListener('input', validateStep);
  });
  document.querySelectorAll('input[type="radio"]').forEach(input => {
    input.addEventListener('change', validateStep);
  });

  // A√±adir secuelas con bot√≥n para quitarlas
  function agregarSecuela(tipo) {
    const puntos = tipo === 'leve' ? 2 : tipo === 'moderada' ? 3 : 10;
    puntosSecuelas += puntos;
    secuelas.push({ tipo, puntos });

    const index = secuelas.length - 1;

    const div = document.createElement('div');
    div.setAttribute("data-index", index);
    div.textContent = `Secuela: ${tipo} `;

    // Icono eliminar (clicable)
    const btnRemove = document.createElement('span');
    btnRemove.innerHTML = "‚ùå Quitar";   // aqu√≠ puedes poner tambi√©n un <i class="fa fa-times"></i> si usas FontAwesome
    btnRemove.style.cursor = "pointer";
    btnRemove.style.marginLeft = "10px";
    btnRemove.title = "Quitar esta secuela";
    btnRemove.onclick = () => quitarSecuela(index, div);

    div.appendChild(btnRemove);
    document.getElementById('secuela_listado').appendChild(div);

    if (puntosSecuelas >= 10 || tipo === 'grave') {
      changeStep(1);
    }
    validateStep();
  }

  // Quitar secuela y restar sus puntos
  function quitarSecuela(index, div) {
    if (secuelas[index]) {
      puntosSecuelas -= secuelas[index].puntos;
      secuelas[index] = null; // marcar eliminada
    }
    div.remove();
    validateStep();
  }

  // Navegaci√≥n
  function changeStep(n) {
    if (n === 1 && !validateStep()) return;

    if (n === 1 && currentStep === steps.length - 1) return;
    if (n === 1 && currentStep === steps.length - 2) calcular();

    steps[currentStep].classList.remove("active");
    currentStep += n;
    steps[currentStep].classList.add("active");
    updateWizard();
  }

  function updateWizard() {
    const totalSteps = steps.length;
    nextBtn.style.display = currentStep === totalSteps - 1 ? "none" : "inline-block";
    prevBtn.style.display = currentStep === 0 || currentStep === totalSteps - 1 ? "none" : "inline-block";
    progressBar.style.width = ((currentStep) / (totalSteps - 1)) * 100 + "%";
    validateStep();
  }

  // Validaci√≥n de cada paso
  function validateStep() {
    const current = steps[currentStep];
    const inputs = current.querySelectorAll("input, select");
    let isValid = true;

    inputs.forEach(input => {
      if (input.offsetParent === null) return;

      if (input.hasAttribute("required") && !input.value) {
        isValid = false;
      }

      if (input.type === "number") {
        const val = parseInt(input.value);
        if (isNaN(val) || val < 0) {
          isValid = false;
        }
      }

      if (input.type === "radio") {
        const name = input.name;
        const radios = current.querySelectorAll(`input[name="${name}"]`);
        const algunoSeleccionado = Array.from(radios).some(r => r.checked);
        if (!algunoSeleccionado) {
          isValid = false;
        }
      }
    });

    // Validaci√≥n adicional: fechas y d√≠as
    const fechaAccidente = new Date(document.getElementById('fecha_accidente')?.value);
    const fechaRehab = new Date(document.getElementById('fecha_rehabilitacion')?.value);
    if (fechaAccidente && fechaRehab && fechaRehab < fechaAccidente) {
      isValid = false;
    }

    const diasTotales = Math.max(0, Math.ceil((fechaRehab - fechaAccidente) / (1000 * 60 * 60 * 24)));
    const diasHosp = parseInt(document.getElementById('dias_hospitalizado')?.value) || 0;
    const diasBaja = parseInt(document.getElementById('dias_baja')?.value) || 0;
    const diasTareas = parseInt(document.getElementById('dias_tareas')?.value) || 0;

    if (diasHosp + diasBaja + diasTareas > diasTotales) {
      isValid = false;
    }

    nextBtn.disabled = !isValid;
    return isValid;
  }

  // C√°lculo final
// C√°lculo final
function calcular() {
  const f1 = new Date(document.getElementById('fecha_accidente').value);
  const f2 = new Date(document.getElementById('fecha_rehabilitacion').value);

  if(f2 < f1) {
    alert("‚ùå La fecha de rehabilitaci√≥n no puede ser anterior a la fecha del accidente.");
    changeStep(-1);
    return;
  }

  const diasTotal = Math.max(0, Math.ceil((f2 - f1) / (1000 * 60 * 60 * 24))+1);
  const diasHosp = parseInt(document.getElementById('dias_hospitalizado')?.value) || 0;
  const diasBaja = parseInt(document.getElementById('dias_baja')?.value) || 0;
  const diasTareas = parseInt(document.getElementById('dias_tareas')?.value) || 0;

  if(diasHosp + diasBaja + diasTareas > diasTotal){
    alert("‚ùå La suma de d√≠as de hospitalizaci√≥n, baja y tareas no puede superar el total de d√≠as entre accidente y rehabilitaci√≥n.");
    changeStep(1);
    return;
  }

  const totalHosp = diasHosp * precioHosp ;
  const totalBaja = diasBaja * precioBaja ;
  const totalTareas = diasTareas * precioBaja ;
  const diasModerados = diasHosp + diasBaja + diasTareas;
  const diasLeves = Math.max(0, diasTotal - diasModerados);
  const totalLeves = diasLeves * precioLeve;
  const euro = v => v.toFixed(2) + " ‚Ç¨";
  let total = totalHosp + totalBaja + totalTareas + totalLeves;

  let resultado = "";

  if (puntosSecuelas >= 10) {
    resultado = `
      <h2 style="color: darkred">‚ö†Ô∏è Atenci√≥n: Secuelas graves detectadas</h2>
      <p>Hemos identificado que tus secuelas podr√≠an ser significativas, lo que indica una situaci√≥n m√°s compleja.</p>
      <p><strong>Para confirmar y conocer el monto real de tu indemnizaci√≥n, es necesario realizar un c√°lculo personalizado.</strong></p>
      <p style="font-size: 18px; margin-top: 10px;"><a href="https://defiendetuaccidente.es/contacto-2/#contacto" style="color: #0073aa; text-decoration: underline;">üëâ Haz clic aqu√≠ para contactar con nuestro equipo especializado</a></p>
       <!-- <div class="reload-buttons">  
           <button type="button" onclick="reiniciarCalculadora()">üîÑ Volver a calcular</button>
        </div><br>-->
      <p style="font-size: 12px; color: #666; margin-top: 30px;">
        *Estimaci√≥n orientativa basada en los datos introducidos. El resultado podr√≠a variar tras el estudio del caso por parte de uno de nuestros profesionales.
      </p>
    `;
  } else {
    const edad = parseInt(document.querySelector('input[name="age"]').value, 10);
    const rangoEdad = obtenerRangoEdad(edad);
    if (rangoEdad && indemnizaciones[rangoEdad]) {
      const compensacionSecuelas = indemnizaciones[rangoEdad][puntosSecuelas - 1] || 0;
      total += compensacionSecuelas;
      resultado = `
        <div style="text-align:center;">
          <h2 style="margin-bottom:0">Total estimado:</h2>
          <h1 style="margin-top:0">${euro(total)}</h1><br>     
          <a href="https://defiendetuaccidente.es/contacto-2/#contacto" 
             style="display:inline-block; background-color:#f97316; color:#fff; 
                    padding:12px 28px; font-size:16px; 
                    font-weight:600; text-decoration:none; transition:background 0.3s ease; margin-top:15px;">
             Contactar
          </a>
          <p style="font-size: 12px; color: #666; margin-top: 30px;">
            *Estimaci√≥n orientativa basada en los datos introducidos. 
            El resultado podr√≠a variar tras el estudio del caso por parte de uno de nuestros profesionales
          </p>
        </div>
      `;
    } else {
      resultado = `<p style="color: red">‚ö†Ô∏è Error: No se pudo calcular la compensaci√≥n por secuelas. Aseg√∫rate de haber seleccionado correctamente tu rango de edad.</p>`;
    }
  }

  document.getElementById('resultado').innerHTML = resultado;
}

  // Establecer fecha m√°xima del accidente como hoy
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('fecha_accidente').setAttribute('max', today);
  document.getElementById('fecha_rehabilitacion').setAttribute('max', today);
  
  updateWizard();
</script>